generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String           @id @default(uuid()) @db.Uuid
  supabaseId         String           @unique
  username           String?
  dob                String?
  address            String?
  role               Role
  ratingPos          Int
  ratingNeg          Int
  emailVerified      Boolean          @default(false)
  bids               Bid[]            @relation("Bidder")
  BidHistory         BidHistory[]
  comments           Comment[]        @relation("UserComment")
  receivedMessages   Message[]        @relation("MessageReceiver")
  sentMessages       Message[]        @relation("MessageSender")
  boughtOrders       Order[]          @relation("Buyer")
  soldOrders         Order[]          @relation("Seller")
  highestBidProducts Product[]        @relation("HighestBidder")
  sellingProduct     Product[]        @relation("ProductSeller")
  receivedRatings    Rating[]         @relation("ReceivedRatings")
  givenRatings       Rating[]         @relation("GivenRatings")
  upgradeRequest     UpgradeRequest[] @relation("UserUpgradeRequest")
  watchList          WatchList[]      @relation("UserWatchList")
  bannedProducts     BannedBidder[]
}

model Product {
  id                  String                   @id @default(uuid())
  sellerID            String                   @db.Uuid
  highestBidderID     String?                  @db.Uuid
  productName         String
  productAvt          String
  categoryID          String
  startingPrice       Int
  bidStep             Int
  buyNowPrice         Int?
  currentPrice        Int?
  startTime           DateTime
  endTime             DateTime
  isExpired           Boolean                  @default(false)
  autoExtend          Boolean                  @default(false)
  sold                Boolean                  @default(false)
  ratingRequired      Boolean                  @default(false)
  search_vector       Unsupported("tsvector")?
  bids                Bid[]                    @relation("BidProduct")
  BidHistory          BidHistory[]
  comments            Comment[]                @relation("ProductComment")
  messages            Message[]                @relation("ProductMessages")
  order               Order?                   @relation("OrderProduct")
  category            Category                 @relation("ProductCategory", fields: [categoryID], references: [id])
  highestBidder       User?                    @relation("HighestBidder", fields: [highestBidderID], references: [id], onDelete: Cascade)
  seller              User                     @relation("ProductSeller", fields: [sellerID], references: [id], onDelete: Cascade)
  productDescriptions ProductDescription[]     @relation("ProductDescription")
  productImages       ProductImage[]           @relation("ProductImages")
  rating              Rating[]
  inWatchList         WatchList[]              @relation("ProductWatchList")
  bannedBidders       BannedBidder[]
}

model ProductDescription {
  id                 String   @id @default(uuid())
  productID          String
  productDescription String
  createdAt          DateTime @default(now())
  product            Product  @relation("ProductDescription", fields: [productID], references: [id], onDelete: Cascade)
}

model ProductImage {
  imageID   String  @id @default(uuid())
  productID String
  imageURL  String
  order     Int
  product   Product @relation("ProductImages", fields: [productID], references: [id], onDelete: Cascade)
}

model Category {
  id             String     @id @default(uuid())
  name           String     @unique
  parentID       String?
  categoryParent Category?  @relation("TreeCategory", fields: [parentID], references: [id], onDelete: Cascade)
  categoryChild  Category[] @relation("TreeCategory")
  product        Product[]  @relation("ProductCategory")
}

model Bid {
  id        String   @id @default(uuid())
  productID String
  bidderID  String   @db.Uuid
  maxPrice  Int
  createdAt DateTime @default(now())
  bidder    User     @relation("Bidder", fields: [bidderID], references: [id])
  product   Product  @relation("BidProduct", fields: [productID], references: [id])
}

model WatchList {
  userID    String   @db.Uuid
  productID String
  createdAt DateTime @default(now())
  product   Product  @relation("ProductWatchList", fields: [productID], references: [id], onDelete: Cascade)
  user      User     @relation("UserWatchList", fields: [userID], references: [id], onDelete: Cascade)

  @@id([userID, productID])
}

model Comment {
  id            String    @id @default(uuid())
  parentID      String?
  userID        String    @db.Uuid
  productID     String
  content       String
  createdAt     DateTime  @default(now())
  parentComment Comment?  @relation("TreeComment", fields: [parentID], references: [id], onDelete: Cascade)
  childComments Comment[] @relation("TreeComment")
  product       Product   @relation("ProductComment", fields: [productID], references: [id], onDelete: Cascade)
  user          User      @relation("UserComment", fields: [userID], references: [id], onDelete: Cascade)
}

model UpgradeRequest {
  id          String        @id @default(uuid())
  userID      String        @db.Uuid
  status      UpgradeStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  decidedTime DateTime?
  user        User          @relation("UserUpgradeRequest", fields: [userID], references: [id], onDelete: Cascade)
}

model Order {
  productID       String      @id
  sellerID        String      @db.Uuid
  buyerID         String      @db.Uuid
  shippingAddress String?
  paymentInvoice  String?
  shippingInvoice String?
  createdAt       DateTime    @default(now())
  status          OrderStatus
  buyer           User        @relation("Buyer", fields: [buyerID], references: [id])
  product         Product     @relation("OrderProduct", fields: [productID], references: [id])
  seller          User        @relation("Seller", fields: [sellerID], references: [id])
}

model Rating {
  productID String
  raterID   String  @db.Uuid
  rateeID   String  @db.Uuid
  isPos     Boolean
  comment   String?
  product   Product @relation(fields: [productID], references: [id], onDelete: Cascade)
  ratee     User    @relation("ReceivedRatings", fields: [rateeID], references: [id], onDelete: Cascade)
  rater     User    @relation("GivenRatings", fields: [raterID], references: [id], onDelete: Cascade)

  @@id([productID, raterID])
}

model SystemParameter {
  id                  String @id @default(uuid())
  autoExtendThreshold Int
  autoExtendTime      Int
  recentlyProductTime Int
}

model Message {
  id         String   @id @default(uuid())
  productID  String
  senderID   String   @db.Uuid
  receiverID String   @db.Uuid
  content    String
  createdAt  DateTime @default(now())
  product    Product  @relation("ProductMessages", fields: [productID], references: [id], onDelete: Cascade)
  receiver   User     @relation("MessageReceiver", fields: [receiverID], references: [id], onDelete: Cascade)
  sender     User     @relation("MessageSender", fields: [senderID], references: [id], onDelete: Cascade)
}

model BidHistory {
  id        String   @id @default(uuid())
  productID String
  bidderID  String   @db.Uuid
  price     Int
  createdAt DateTime @default(now())
  User      User     @relation(fields: [bidderID], references: [id], onDelete: Cascade)
  Product   Product  @relation(fields: [productID], references: [id], onDelete: Cascade)
}

model BannedBidder {
  id        String   @id @default(uuid())
  productID String
  bidderID  String   @db.Uuid
  createdAt DateTime @default(now())

  product Product @relation(fields: [productID], references: [id], onDelete: Cascade)
  bidder  User    @relation(fields: [bidderID], references: [id], onDelete: Cascade)

  @@unique([productID, bidderID])
}


enum Role {
  BIDDER
  SELLER
  ADMIN
}

enum UpgradeStatus {
  PENDING
  FAILED
  ACCEPT
}

enum OrderStatus {
  CREATED
  RECEIVEPAYMENT
  UPDATESHIPPINGINVOICE
  PROVIDEBUYERINFO
  RECEIVEPRODUCT
  CANCELORDER
  RATING
}
